<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Produk</title>
  <!-- Bootstrap CSS + Animate.css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Cloudinary widget -->
  <style>
    html, body { height:100%; margin:0; overflow:hidden; }
    #wrapper { display:flex; height:100%; }
    #sidebar { width:250px; background:#343a40; color:#ddd; display:flex; flex-direction:column; }
    #sidebar .sidebar-heading { padding:1rem; color:#fff; border-bottom:1px solid rgba(255,255,255,0.1); text-align:center; }
    #sidebar .list-group-item { background:transparent; border:none; color:#ccc; }
    #sidebar .list-group-item.active, #sidebar .list-group-item:hover { background:#495057; color:#fff; }
    #page-content-wrapper { flex-grow:1; display:flex; flex-direction:column; background:#f8f9fa; }
    .navbar { background:#343a40; flex-shrink:0; }
    #content { flex-grow:1; overflow-y:auto; padding:1rem; }
    .card-custom { border:none; border-radius:0.75rem; box-shadow:0 0.5rem 1rem rgba(0,0,0,0.1); }
    /* mobile tweaks */
    @media (max-width:576px) {
      #sidebar { position:fixed; bottom:0; width:100%; height:50px; flex-direction:row; }
      #sidebar .sidebar-heading { display:none; }
      #sidebar .list-group { flex-direction:row; width:100%; }
      #sidebar .list-group-item { flex:1; justify-content:center; font-size:0; }
      #sidebar .list-group-item i { font-size:1.25rem; }
      #menu-toggle { display:none; }
      #btnTambahMobile {
        font-size: 1.5rem;
        text-align: center;
      }
      .mobile-nav-item {
        flex: 1;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0;
        border-right: 1px solid #ccc;
        background-color: #f8f9fa;
      }

      .mobile-nav-item:last-child {
        border-right: none;
      }

      #btnTambahMobile {
        width: 60px;
        height: 60px;
        border-radius: 0;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
      }

      #content { padding-bottom:3rem; }
    }
        /* Tampilkan teks pada layar desktop */
    .d-none {
      display: none !important;
    }

    .d-md-inline {
      display: inline-block !important;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
      <div class="sidebar-heading">ADMIN PRODUK</div>
      <div class="list-group list-group-flush flex-grow-1">

        <!-- Tombol Produk -->
        <a href="#" class="list-group-item list-group-item-action mobile-nav-item" data-menu="produk">
          <i class="bi bi-box-seam-fill" style="font-size: 1.5rem;"></i>
          <span class="d-none d-md-inline ms-2">Produk</span> <!-- Teks untuk Desktop -->
        </a>

        <!-- Tombol Tambah (di tengah) -->
        <a href="#" id="btnTambahMobile" class="list-group-item list-group-item-action btn btn-success" style="background-color: rgb(21, 117, 85);">
          <i class="bi bi-plus-lg" style="font-size: 1.5rem; font-weight: bolder; color: white;"></i>
          <span class="d-none d-md-inline ms-2">Tambah</span> <!-- Teks untuk Desktop -->
        </a>

        <!-- Tombol Populer -->
        <a href="#" class="list-group-item list-group-item-action mobile-nav-item" data-menu="populer">
          <i class="bi bi-fire" style="font-size: 1.5rem;"></i>
          <span class="d-none d-md-inline ms-2">Populer</span> <!-- Teks untuk Desktop -->
        </a>

                
      </div>
    </nav>
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <nav class="navbar border-bottom shadow-sm">
        <div class="container-fluid">
          <button class="btn btn-outline-secondary me-3" id="menu-toggle"><i class="bi bi-list fs-4"></i></button>
          <span class="navbar-brand ms-2 fw-bold text-white">Admin Produk</span>
        </div>
      </nav>
      <div id="content"><!-- konten dinamis --></div>
    </div>
  </div>

  <!-- Modal Produk (Add/Edit) -->
  <div class="modal fade animate__animated animate__fadeIn" id="modalProduk" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form id="formProduk" class="modal-content card-custom">
        <div class="modal-header border-0">
          <h5 class="modal-title">Tambah / Edit Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row">
          <input type="hidden" id="prodId">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nama</label>
            <input type="text" id="prodNama" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Kategori</label>
            <input type="text" id="prodKategori" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 50</label>
            <input type="number" id="prodHarga50" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 100</label>
            <input type="number" id="prodHarga100" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 200</label>
            <input type="number" id="prodHarga200" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 300</label>
            <input type="number" id="prodHarga300" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 400</label>
            <input type="number" id="prodHarga400" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 500</label>
            <input type="number" id="prodHarga500" class="form-control">
          </div>
          <div class="col-12 mb-3">
            <label class="form-label">Deskripsi</label>
            <textarea id="prodDeskripsi" class="form-control" rows="3"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Gambar Utama</label><br>
            <button type="button" class="btn btn-secondary" id="uploadProdBtn">
              <i class="bi bi-upload me-1"></i>Upload (max 5)
            </button>
            <!-- Satu input untuk menampung array URL -->
            <input type="hidden" id="prodGambar" name="prodGambar">
            <!-- Container untuk menampung thumbnail -->
            <div class="mt-2" id="thumbProdContainer"></div>
            
              <img id="thumbProd" class="img-thumbnail" style="width:100px; display:none;">
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-primary w-100">
              <span class="spinner-border spinner-border-sm me-2 d-none"></span>Simpan
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tombol Tambah Produk Tetap -->
  <button id="btnTambahFloating" class="btn btn-success rounded-circle position-fixed d-none d-md-flex align-items-center justify-content-center" style="bottom:20px; right:20px; width:50px; height:50px; z-index:1030;">
    <i class="bi bi-plus-lg fs-3"></i>
  </button>


  <!-- JS deps -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <script>
    const scriptBaseUrl = 'https://script.google.com/macros/s/AKfycbzTSN5GdU6TnFflUYhfO1IPqBVO9wIf_UNEnLZdpXLYf7xQICw10Iv9hCW2wHQVDdb6hQ/exec';
    const cloudName    = 'dhsq8zrvy';
    const uploadPreset = 'preset_upload_mokas';
  
    $(document).ready(function() {
      let uploadedImages = [];
  
      // Inisialisasi Cloudinary upload widget
      const widget = cloudinary.createUploadWidget({
        cloudName,
        uploadPreset,
        multiple: true,
        maxFiles: 5,
        sources: ["local","url","camera"]
      }, (err, res) => {
        if (!err && res.event === "success") {
          uploadedImages.push(res.info.secure_url);
  
          // Render thumbnail dengan tombol remove
          $('#thumbProdContainer').append(`
            <div class="position-relative d-inline-block me-2 mb-2 image-item">
              <img src="${res.info.secure_url}"
                   class="img-thumbnail"
                   style="width:100px;">
              <button type="button"
                      class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-remove-image">
                &times;
              </button>
            </div>
          `);
  
          // Update hidden input
          $('#prodGambar').val(JSON.stringify(uploadedImages));
        }
      });
  
      // Handler untuk tombol × pada thumbnail (hapus satu per satu)
      $('#thumbProdContainer').on('click', '.btn-remove-image', function() {
        const $item = $(this).closest('.image-item');
        const src   = $item.find('img').attr('src');
        uploadedImages = uploadedImages.filter(u => u !== src);
        $('#prodGambar').val(JSON.stringify(uploadedImages));
        $item.remove();
      });
  
      // Buka widget ketika tombol Upload diklik
      $('#uploadProdBtn').on('click', function() {
        uploadedImages = [];
        $('#prodGambar').val('[]');
        $('#thumbProdContainer').empty();
        widget.open();
      });
  
      // Handler tombol tambah (“+”) di sidebar & floating
      $('#btnTambahMobile, #btnTambahFloating').on('click', function() {
        clearForm();
        $('#modalProduk').modal('show');
      });
  
      // Menu aktif & load default
      function setActive(menu) {
        $('[data-menu]').removeClass('active');
        $(`[data-menu="${menu}"]`).addClass('active');
        menu === 'produk' ? loadProduk() : loadPopuler();
      }
      setActive('produk');
  
      // Load daftar Produk
      function loadProduk() {
        $.getJSON(`${scriptBaseUrl}?sheet=Produk`, products => {
          // Simpan ke localStorage
          localStorage.setItem('produkData', JSON.stringify(products));

          // Tampilkan data ke tabel
          let html = `
            <table class="table table-striped">
              <thead><tr>
                <th>ID</th><th>Nama</th><th>Kategori</th><th>Gambar</th><th>Aksi</th>
              </tr></thead><tbody>`;
          products.forEach(p => {
            const thumb = p.gambar[0]
              ? `<img src="${p.gambar[0]}" style="width:50px; height:50px; object-fit:cover;">`
              : '';
              const isMobile = window.innerWidth < 576;
              html += `
                <tr ${isMobile ? `class="row-produk"` : ''} data-id="${p.id}" ${isMobile ? `style="cursor:pointer;"` : ''}>                  
                  <td>${p.id}</td>
                  <td>${p.nama}</td>
                  <td>${p.kategori}</td>
                  <td>${thumb}</td>
                  <td>
                    <button class="btn btn-sm btn-primary btn-edit d-none d-md-inline" data-id="${p.id}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete" data-id="${p.id}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>`;
          });
          const isMobile = window.innerWidth < 576;
          html += `</tbody></table>`;
          $('#content').html(html);
        }).fail(() => {
          // Jika gagal ambil data dari server, ambil dari localStorage
          const dataProduk = JSON.parse(localStorage.getItem('produkData') || '[]');
          if (dataProduk.length === 0) {
            $('#content').html('<div class="alert alert-warning">Tidak bisa memuat data dan tidak ada data tersimpan.</div>');
            return;
          }

          let html = `
            <div class="alert alert-info">Menampilkan data dari cache lokal.</div>
            <table class="table table-striped">
              <thead><tr>
                <th>ID</th><th>Nama</th><th>Kategori</th><th>Gambar</th><th>Aksi</th>
              </tr></thead><tbody>`;
          dataProduk.forEach(p => {
            const thumb = p.gambar[0]
              ? `<img src="${p.gambar[0]}" style="width:50px; height:50px; object-fit:cover;">`
              : '';
              html += `
              <tr ${isMobile ? `class="row-produk"` : ''} data-id="${p.id}" ${isMobile ? `style="cursor:pointer;"` : ''}>                  
                  <td>${p.id}</td>
                  <td>${p.nama}</td>
                  <td>${p.kategori}</td>
                  <td>${thumb}</td>
                  <td>
                    <button class="btn btn-sm btn-primary btn-edit d-none d-md-inline" data-id="${p.id}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete" data-id="${p.id}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>`;
          });
          html += `</tbody></table>`;
          $('#content').html(html);
        });
      }

  
      // Load Produk Terpopuler
      function loadPopuler() {
        $.getJSON(`${scriptBaseUrl}?sheet=Produk`, products => {
          localStorage.setItem('produkData', JSON.stringify(products));
          const top10 = products.sort((a,b)=>(b.klik||0)-(a.klik||0)).slice(0,10);
          let html = `
            <h4 class="mb-3">Produk Terpopuler</h4>
            <table class="table table-bordered table-striped">
              <thead><tr>
                <th>ID</th><th>Nama</th><th>Gambar</th><th>Klik</th>
              </tr></thead><tbody>`;
          top10.forEach(p => {
            const img = p.gambar[0]
              ? `<img src="${p.gambar[0]}" style="width:60px; height:60px; object-fit:cover;">`
              : '';
            html += `
              <tr>
                <td>${p.id}</td>
                <td>${p.nama}</td>
                <td>${img}</td>
                <td>${p.klik||0}</td>
              </tr>`;
          });
          html += `</tbody></table>`;
          $('#content').html(html);
        });
      }
  
      // Tombol “Tambah” dalam content
      $('#content').on('click', '#btnTambah', () => {
        clearForm();
        $('#modalProduk').modal('show');
      });
  
      // Edit Produk
      $('#content').on('click', '.btn-edit', function() {
        const id = $(this).data('id');
        $.getJSON(`${scriptBaseUrl}?sheet=Produk`, products => {
          localStorage.setItem('produkData', JSON.stringify(products));
          const p = products.find(x => x.id === id);
          if (!p) return Swal.fire('Error','Data tidak ditemukan','error');
          $('#prodId').val(p.id);
          $('#prodNama').val(p.nama);
          $('#prodKategori').val(p.kategori);
          $('#prodHarga50').val(p.harga50);
          $('#prodHarga100').val(p.harga100);
          $('#prodHarga200').val(p.harga200);
          $('#prodHarga300').val(p.harga300);
          $('#prodHarga400').val(p.harga400);
          $('#prodHarga500').val(p.harga500);
          $('#prodDeskripsi').val(p.deskripsi);
  
          // Tampilkan kembali thumbnails lama
          uploadedImages = p.gambar.slice();
          $('#thumbProdContainer').empty();
          uploadedImages.forEach(u => {
            $('#thumbProdContainer').append(`
              <div class="position-relative d-inline-block me-2 mb-2 image-item">
                <img src="${u}" class="img-thumbnail" style="width:100px;">
                <button type="button"
                        class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-remove-image">
                  &times;
                </button>
              </div>
            `);
          });
          $('#prodGambar').val(JSON.stringify(uploadedImages));
          $('#modalProduk').modal('show');
        });
      });
  
      // Submit Form Insert / Update
      $('#formProduk').submit(function(e) {
        e.preventDefault();
        const id = $('#prodId').val();
        const action = id ? 'update' : 'insert';
        const btn = $(this).find('button[type=submit]');
        btn.attr('disabled', true).find('.spinner-border').removeClass('d-none');
  
        const payload = {
          sheet: 'Produk',
          action,
          id: id ? parseInt(id,10) : undefined,
          nama: $('#prodNama').val(),
          kategori: $('#prodKategori').val(),
          harga50:  parseFloat($('#prodHarga50').val())  || 0,
          harga100: parseFloat($('#prodHarga100').val()) || 0,
          harga200: parseFloat($('#prodHarga200').val()) || 0,
          harga300: parseFloat($('#prodHarga300').val()) || 0,
          harga400: parseFloat($('#prodHarga400').val()) || 0,
          harga500: parseFloat($('#prodHarga500').val()) || 0,
          deskripsi: $('#prodDeskripsi').val(),
          gambar: JSON.stringify(uploadedImages)
        };
  
        $.ajax({
          url:         scriptBaseUrl,
          method:      'POST',
          crossDomain: true,
          contentType: 'text/plain; charset=UTF-8',
          dataType:    'json',
          data:        JSON.stringify(payload)
        })
        .done(res => {
          Swal.fire(res.success ? 'Sukses' : 'Gagal', res.message, res.success ? 'success' : 'error');
          if (res.success) {
            $('#modalProduk').modal('hide');
            loadProduk();
          }
        })
        .fail(() => {
          Swal.fire('Error','Tidak dapat menghubungi server.','error');
        })
        .always(() => {
          btn.attr('disabled', false).find('.spinner-border').addClass('d-none');
        });
      });
  
      // Delete Produk
      $('#content').on('click', '.btn-delete', function() {
        const id = $(this).data('id');
        Swal.fire({
          title: 'Hapus produk?',
          text:  `ID ${id} akan dihapus.`,
          icon:  'warning',
          showCancelButton: true,
          confirmButtonText: 'Ya, hapus'
        }).then(res => {
          if (!res.isConfirmed) return;
          $.ajax({
            url:         scriptBaseUrl,
            method:      'POST',
            crossDomain: true,
            contentType: 'text/plain; charset=UTF-8',
            dataType:    'json',
            data:        JSON.stringify({ sheet: 'Produk', action: 'delete', id: parseInt(id,10) })
          })
          .done(r => {
            if (r.success) {
              Swal.fire('Terhapus!', r.message, 'success');
              loadProduk();
            } else {
              Swal.fire('Gagal!', r.message, 'error');
            }
          })
          .fail(() => {
            Swal.fire('Error','Tidak dapat menghubungi server.','error');
          });
        });
      });
  
      // Reset form
      function clearForm() {
        $('#formProduk')[0].reset();
        $('#prodId').val('');
        uploadedImages = [];
        $('#prodGambar').val('[]');
        $('#thumbProdContainer').empty();
      }
  
      // Menu klik
      $(document).on('click','[data-menu="produk"]', ()=>setActive('produk'));
      $(document).on('click','[data-menu="populer"]', ()=>setActive('populer'));

      $(document).on('click', '.row-produk', function(e) {
        // Hindari konflik jika user klik tombol Delete (biar tetap bisa diakses)
        if ($(e.target).closest('button').length > 0) return;

        const id = $(this).data('id');
        const isMobile = window.innerWidth < 768;

        if (isMobile) {
          // Muat data produk dan isi form
          const products = JSON.parse(localStorage.getItem('produkData') || '[]');
          const p = products.find(x => x.id == id);
          if (!p) return Swal.fire('Error','Data tidak ditemukan','error');

          $('#prodId').val(p.id);
          $('#prodNama').val(p.nama);
          $('#prodKategori').val(p.kategori);
          $('#prodHarga50').val(p.harga50);
          $('#prodHarga100').val(p.harga100);
          $('#prodHarga200').val(p.harga200);
          $('#prodHarga300').val(p.harga300);
          $('#prodHarga400').val(p.harga400);
          $('#prodHarga500').val(p.harga500);
          $('#prodDeskripsi').val(p.deskripsi);

          uploadedImages = p.gambar.slice();
          $('#thumbProdContainer').empty();
          uploadedImages.forEach(u => {
            $('#thumbProdContainer').append(`
              <div class="position-relative d-inline-block me-2 mb-2 image-item">
                <img src="${u}" class="img-thumbnail" style="width:100px;">
                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-remove-image">&times;</button>
              </div>
            `);
          });
          $('#prodGambar').val(JSON.stringify(uploadedImages));

          $('#modalProduk').modal('show');
        }
      });


      
    });
  </script>
  
  


</body>
</html>
