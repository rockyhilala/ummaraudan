<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Produk</title>
  <!-- Bootstrap CSS + Animate.css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Cloudinary widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <style>
    html, body { height:100%; margin:0; overflow:hidden; }
    #wrapper { display:flex; height:100%; }
    #sidebar { width:250px; background:#343a40; color:#ddd; display:flex; flex-direction:column; }
    #sidebar .sidebar-heading { padding:1rem; color:#fff; border-bottom:1px solid rgba(255,255,255,0.1); text-align:center; }
    #sidebar .list-group-item { background:transparent; border:none; color:#ccc; }
    #sidebar .list-group-item.active, #sidebar .list-group-item:hover { background:#495057; color:#fff; }
    #page-content-wrapper { flex-grow:1; display:flex; flex-direction:column; background:#f8f9fa; }
    .navbar { background:#343a40; flex-shrink:0; }
    #content { flex-grow:1; overflow-y:auto; padding:1rem; }
    .card-custom { border:none; border-radius:0.75rem; box-shadow:0 0.5rem 1rem rgba(0,0,0,0.1); }
    /* mobile tweaks */
    @media (max-width:576px) {
      #sidebar { position:fixed; bottom:0; width:100%; height:50px; flex-direction:row; }
      #sidebar .sidebar-heading { display:none; }
      #sidebar .list-group { flex-direction:row; width:100%; }
      #sidebar .list-group-item { flex:1; justify-content:center; font-size:0; }
      #sidebar .list-group-item i { font-size:1.25rem; }
      #menu-toggle { display:none; }
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
      <div class="sidebar-heading">ADMIN PRODUK</div>
      <div class="list-group list-group-flush flex-grow-1">
        <a href="#" class="list-group-item list-group-item-action active" data-menu="produk">
          <i class="bi bi-box-seam-fill"></i><span class="sidebar-text ms-2">Produk</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-menu="populer">
          <i class="bi bi-fire"></i><span class="sidebar-text ms-2">Populer</span>
        </a>        
      </div>
    </nav>
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <nav class="navbar border-bottom shadow-sm">
        <div class="container-fluid">
          <button class="btn btn-outline-secondary me-3" id="menu-toggle"><i class="bi bi-list fs-4"></i></button>
          <span class="navbar-brand ms-2 fw-bold text-white">Admin Produk</span>
        </div>
      </nav>
      <div id="content"><!-- konten dinamis --></div>
    </div>
  </div>

  <!-- Modal Produk (Add/Edit) -->
  <div class="modal fade animate__animated animate__fadeIn" id="modalProduk" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form id="formProduk" class="modal-content card-custom">
        <div class="modal-header border-0">
          <h5 class="modal-title">Tambah / Edit Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row">
          <input type="hidden" id="prodId">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nama</label>
            <input type="text" id="prodNama" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Kategori</label>
            <input type="text" id="prodKategori" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 50</label>
            <input type="number" id="prodHarga50" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 100</label>
            <input type="number" id="prodHarga100" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 200</label>
            <input type="number" id="prodHarga200" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 300</label>
            <input type="number" id="prodHarga300" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 400</label>
            <input type="number" id="prodHarga400" class="form-control">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Harga 500</label>
            <input type="number" id="prodHarga500" class="form-control">
          </div>
          <div class="col-12 mb-3">
            <label class="form-label">Deskripsi</label>
            <textarea id="prodDeskripsi" class="form-control" rows="3"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Gambar Utama</label><br>
            <button type="button" class="btn btn-secondary" id="uploadProdBtn">
              <i class="bi bi-upload me-1"></i>Upload
            </button>
            <input type="hidden" id="prodGambar1">
            <div class="mt-2">
              <img id="thumbProd" class="img-thumbnail" style="width:100px; display:none;">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-primary w-100">
            <span class="spinner-border spinner-border-sm me-2 d-none"></span>Simpan
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS deps -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      const scriptBaseUrl = 'https://script.google.com/macros/s/AKfycbzTSN5GdU6TnFflUYhfO1IPqBVO9wIf_UNEnLZdpXLYf7xQICw10Iv9hCW2wHQVDdb6hQ/exec';
      const cloudName    = 'dhsq8zrvy';
      const uploadPreset = 'preset_upload_mokas';

  $(document).ready(function() {
    // Inisialisasi Cloudinary upload widget
    const widget = cloudinary.createUploadWidget({
      cloudName: cloudName,
      uploadPreset: uploadPreset,
      multiple: false,
      sources: ["local", "url", "camera"]
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        $('#prodGambar1').val(result.info.secure_url);
        $('#thumbProd').attr('src', result.info.secure_url).show();
      }
    });

    // Buka widget ketika tombol Upload diklik
    $('#uploadProdBtn').click(() => widget.open());

    // Load konten default: list produk
    loadProduk();

    // Fungsi Load Produk
    function loadProduk() {
      $.getJSON(`${scriptBaseUrl}?sheet=Produk`, function(products) {
        let html = `
          <button class="btn btn-success mb-3" id="btnTambah"><i class="bi bi-plus-lg"></i> Tambah Produk</button>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th><th>Nama</th><th>Kategori</th><th>Harga</th><th>Gambar</th><th>Aksi</th>
              </tr>
            </thead><tbody>`;
        products.forEach(p => {
          const thumb = p.gambar[0]
            ? `<img src="${p.gambar[0]}" style="width:50px;height:auto;">`
            : '';
          html += `
            <tr>
              <td>${p.id}</td>
              <td>${p.nama}</td>
              <td>${p.kategori}</td>
              <td>${p.harga}</td>
              <td>${thumb}</td>
              <td>
                <button class="btn btn-sm btn-primary btn-edit" data-id="${p.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${p.id}"><i class="bi bi-trash"></i></button>
              </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        $('#content').html(html);
      });
    }

    // Tampilkan modal untuk tambah
    $('#content').on('click', '#btnTambah', function() {
      clearForm();
      $('#modalProduk').modal('show');
    });

    // Tampilkan modal untuk edit
    $('#content').on('click', '.btn-edit', function() {
      const id = $(this).data('id');
      // Ambil detail produk via filter dari load sebelumnya (atau reload):
      $.getJSON(`${scriptBaseUrl}?sheet=Produk`, function(products) {
        const p = products.find(x => x.id === id);
        if (!p) return Swal.fire('Error', 'Data tidak ditemukan', 'error');
        // Isi form
        $('#prodId').val(p.id);
        $('#prodNama').val(p.nama);
        $('#prodKategori').val(p.kategori);
        $('#prodHarga50').val(p.harga50);
        $('#prodHarga100').val(p.harga100);
        $('#prodHarga200').val(p.harga200);
        $('#prodHarga300').val(p.harga300);
        $('#prodHarga400').val(p.harga400);
        $('#prodHarga500').val(p.harga500);
        $('#prodDeskripsi').val(p.deskripsi);
        if (p.gambar[0]) {
          $('#prodGambar1').val(p.gambar[0]);
          $('#thumbProd').attr('src', p.gambar[0]).show();
        } else {
          $('#thumbProd').hide();
        }
        $('#modalProduk').modal('show');
      });
    });

    // Submit form (insert / update)
    $('#formProduk').submit(function(e) {
      e.preventDefault();
      const id = $('#prodId').val();
      const action = id ? 'update' : 'insert';
      // Disable tombol sambil loading
      const btn = $(this).find('button[type=submit]');
      btn.attr('disabled', true).find('.spinner-border').removeClass('d-none');

      const payload = {
        sheet: 'Produk',
        action: action,
        id: id ? parseInt(id,10) : undefined,
        nama: $('#prodNama').val(),
        kategori: $('#prodKategori').val(),
        harga50: parseFloat($('#prodHarga50').val()) || 0,
        harga100: parseFloat($('#prodHarga100').val()) || 0,
        harga200: parseFloat($('#prodHarga200').val()) || 0,
        harga300: parseFloat($('#prodHarga300').val()) || 0,
        harga400: parseFloat($('#prodHarga400').val()) || 0,
        harga500: parseFloat($('#prodHarga500').val()) || 0,
        deskripsi: $('#prodDeskripsi').val(),
        gambar1: $('#prodGambar1').val()
      };

      $.ajax({
        url: scriptBaseUrl,
        method: 'POST',
        data: JSON.stringify(payload),
        contentType: 'text/plain; charset=UTF-8',   // <<< simple content-type
        dataType: 'json',                           // output kamu tetap JSON
        success: function(res) {
          Swal.fire('Sukses', res.message, 'success');
          $('#modalProduk').modal('hide');
          loadProduk();
        },
        error: function(err) {
          Swal.fire('Error', 'Terjadi kesalahan', 'error');
        },
        complete: function() {
          btn.attr('disabled', false).find('.spinner-border').addClass('d-none');
        }
      });
    });

    // Delete produk
    $('#content').on('click', '.btn-delete', function() {
      const id = $(this).data('id');

      Swal.fire({
        title: 'Hapus produk?',
        text: `Produk dengan ID ${id} akan dihapus.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, hapus',
        cancelButtonText: 'Batal'
      }).then(result => {
        if (!result.isConfirmed) return;

        $.ajax({
          url: scriptBaseUrl,
          method: 'POST',
          data: JSON.stringify({
            sheet: 'Produk',
            action: 'delete',
            id: parseInt(id, 10)
          }),
          contentType: 'text/plain; charset=UTF-8',  // <<< penting untuk hindari CORS preflight
          dataType: 'json',
          success: function(res) {
            if (res.success) {
              Swal.fire('Terhapus!', res.message, 'success');
              loadProduk();
            } else {
              Swal.fire('Gagal!', res.message, 'error');
            }
          },
          error: function(err) {
            Swal.fire('Error', 'Tidak dapat menghubungi server.', 'error');
          }
        });
      });
    });


    // Reset form fields
    function clearForm() {
      $('#formProduk')[0].reset();
      $('#prodId').val('');
      $('#thumbProd').hide();
    }
  });

    // Klik menu Populer
  $(document).on('click', '[data-menu="populer"]', function() {
    $.getJSON(`${scriptBaseUrl}?sheet=Produk`, function(products) {
      const top = products
        .sort((a, b) => (b.klik || 0) - (a.klik || 0))
        .slice(0, 10); // ambil 10 besar

      let html = `
        <h4 class="mb-3">Produk Terpopuler</h4>
        <table class="table table-bordered table-striped">
          <thead><tr>
            <th>ID</th><th>Nama</th><th>Gambar</th><th>Klik</th>
          </tr></thead><tbody>`;

      top.forEach(p => {
        const img = p.gambar[0]
          ? `<img src="${p.gambar[0]}" style="width:60px;">`
          : '';
        html += `<tr>
          <td>${p.id}</td>
          <td>${p.nama}</td>
          <td>${img}</td>
          <td>${p.klik || 0}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      $('#content').html(html);
    });
  });

  </script>
</body>
</html>
